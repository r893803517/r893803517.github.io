#### 大致流程

![how-to-run](..\img\how-to-run.png)

可以分为三个阶段：

##### 1. 词法分析

　JS 脚本加载完毕后，会首先进入语法分析阶段，它首先会分析代码块的语法是否正确，不正确则抛出“语法错误”，停止执行。

　几个步骤：

- 分词，例如将`var a = 2`，，分成`var`、`a`、`=`、`2`这样的词法单元。
- 解析，将词法单元转换成抽象语法树（AST）。
- 代码生成，将抽象语法树转换成机器指令。

##### 2. 预编译

　JS 有三种运行环境：

- 全局环境
- 函数环境
- eval

　每进入一个不同的运行环境都会创建一个对应的执行上下文，根据不同的上下文环境，形成一个函数调用栈，栈底永远是全局执行上下文，栈顶则永远是当前执行上下文。

> **创建执行上下文**
>
> 创建执行上下文的过程中，主要做了以下三件事：
>
> - 创建变量对象
>
> - - 参数、函数、变量
>
> - 建立作用域链
>
> - - 确认当前执行环境是否能访问变量
>
> - 确定 This 指向



##### 3. 执行

　虽然 JS 是单线程的，但实际上参与工作的线程一共有四个：

1. JS 引擎线程：也叫 JS 内核，负责解析执行 JS 脚本程序的主线程，例如 V8 引擎
2. 事件触发线程：属于浏览器内核线程，主要用于控制事件，例如鼠标、键盘等，当事件被触发时，就会把事件的处理函数推进事件队列，等待 JS 引擎线程执行
3. 定时器触发线程：主要控制`setInterval`和`setTimeout`，用来计时，计时完毕后，则把定时器的处理函数推进事件队列中，等待 JS 引擎线程。
4. HTTP 异步请求线程：通过XMLHttpRequest连接后，通过浏览器新开的一个线程，监控readyState状态变更时，如果设置了该状态的回调函数，则将该状态的处理函数推进事件队列中，等待JS引擎线程执行。

> 浏览器对同一域名的并发连接数是有限的，通常为 6 个。

